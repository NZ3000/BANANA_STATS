---
title: "Banana,US"
author: "Team 1"
date: "03/12/2024"

execute:
  echo: false
  
format: 
  html:
    math: true
    toc: true  # Enable the table of contents
    toc-title: "Contents"  # Set the TOC title
    toc-depth: 2  # Limit TOC depth level
    code-fold: true  # Allow code blocks to be collapsible
    code-tools: false  # Show tools for code blocks (like copy button)
    code-copy: true  # Enable copy button for code blocks
    theme: Materia  # Use the "Lux" Bootswatch theme
    smooth-scroll: true  # Enable smooth scrolling for TOC links
    embed-resources: true  # Embed external resources directly
---

```{r}
#| echo: false
#| message: false
#| warning: false

# Set a CRAN mirror
options(repos = c(CRAN = "https://cran.rstudio.com"))

# install.packages('ggplot2')
# install.packages('ggthemes')
# install.packages("stargazer")
# install.packages("wooldridge")
# install.packages("knitr")
# install.packages("modelsummary")
# install.packages("naniar")
# install.packages("kableExtra")
# install.packages("lmtest")
# install.packages("tsibble")
# install.packages("fable")
# install.packages("lubridate")
# install.packages("forecast")
# install.packages("urca")
# install.packages("broom")
# install.packages("plm")
# install.packages("fabletools")
# install.packages("lubridate")
# install.packages("plotly")



library(ggplot2)
library(ggthemes)
library(stargazer)
library(wooldridge)
library(knitr)
library(dplyr)
library(car)
library(modelsummary)
library(readxl)
library(naniar)
library(kableExtra)
library(lmtest)
library(tidyr)
library(tsibble)
library(lubridate)
library(forecast)
library(urca)
library(broom)
library(plm)
library(readr)
library(fable)
library(fabletools)
library(lubridate)
library(plotly)
library(gganimate)

invisible(Sys.setlocale("LC_TIME", "en_US.UTF-8")) # Set months in English without output
```

```{r}

banana_tsibble <- suppressMessages(
  read_csv("Cleaned_Commodity_Prices.csv", show_col_types = FALSE) |>
    select(Year, Month, `Banana, US`) |>
    mutate(Date = yearmonth(paste(Year, Month, sep = "-"))) |>
    select(Date, `Banana, US`) |>                             
    as_tsibble(index = Date)
)

```

Data

```{r}
autoplot(banana_tsibble, `Banana, US`) +
  ggtitle("Banana Prices Over Time") +
  xlab("Date") +
  ylab("Price (US $)") +
  theme_minimal()
```

Time Plot description

```{r}
banana_tsibble |>
  mutate(Month = month(Date, label = TRUE),   # Extract month as a factor
         Year = year(Date),                   # Extract year
         Decade = floor(Year / 10) * 10) |>   # Create a decade variable
  filter(Year %% 3 == 0) |>                   # Select only years divisible by 3
  ggplot(aes(x = Month, y = `Banana, US`, color = factor(Year), group = Year)) +
  geom_line() +
  labs(y = "$ (USD)",
       title = "Seasonal Plot: Banana Prices in US by Decade (Sampled Years)") +
  facet_wrap(~ Decade, scales = "fixed", ncol = 2) +  # Two columns for better readability
  theme_minimal() +
  theme(legend.position = "none",               # Remove the legend
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
banana_tsibble |>
  mutate(Month = month(Date, label = TRUE)) |>  # Extract month as a factor
  group_by(Month) |>                            # Group by month
  summarise(AveragePrice = mean(`Banana, US`, na.rm = TRUE)) |>  # Calculate average price
  ggplot(aes(x = Month, y = AveragePrice, group = 1)) +
  geom_line(color = "blue", linewidth = 1) +      # Use linewidth instead of size
  geom_point(color = "blue", size = 3) +          # Add points to highlight averages
  labs(y = "$ (USD)",
       title = "Average Monthly Banana Prices in US",
       x = "Month") +
  theme_minimal()
```

Insights

```{r}
banana_tsibble |>
  mutate(Month = month(Date, label = TRUE)) |>  # Extract Month as factor
  ggplot(aes(x = Month, y = `Banana, US`)) +
  geom_boxplot(fill = "lightblue", alpha = 0.6) +  # Boxplot
  stat_summary(fun = mean, geom = "line", aes(group = 1), color = "blue", size = 1) +  # Mean line
  labs(y = "$/kg", 
       title = "Boxplot of Banana Prices by Month with Mean Line",
       x = "Month") +
  theme_minimal()
```

## Insights from the Boxplot:

1.  **Price Stability**:

    -   Most boxes have a similar size and position, indicating relatively stable banana prices throughout the year.
    -   There are no sharp changes in medians between months, meaning average banana prices remain at a similar level year-round.

2.  **Price Variability**:

    -   The whiskers are quite long, showing significant variability in prices across different years.
    -   The highest variability is observed in **January, June, and September**, as their whiskers are the longest, and there are several outliers.

3.  **Outliers**:

    -   Outliers appear in several months, especially in **January, June, and December**, which may indicate extreme banana prices in specific years.
    -   These outliers might be caused by economic or climatic events affecting banana supply during these periods.

    ```{r}
    banana_yearly <- banana_tsibble %>%
      index_by(Year = year(Date)) %>%  # Group by year
      summarise(Avg_Price = mean(`Banana, US`, na.rm = TRUE))  # Compute yearly average

    # Create an interactive plot using plotly
    plot_ly(banana_yearly, x = ~Year, y = ~Avg_Price, type = 'scatter', mode = 'lines+markers') %>%
      layout(title = "Interactive Time Series Plot: Banana Prices",
             xaxis = list(title = "Year"),
             yaxis = list(title = "Price ($/kg)"))
    ```

    ```{r}
    # Assuming Banana_price is already loaded and is in the tsibble format

# Convert the tsibble to a data frame for easier manipulation
ts_df <- as.data.frame(banana_tsibble)

# Log transformation of the data
ts_df$Log_Level <- log(ts_df$`Banana, US`)

# First differences of the data (difference in price)
ts_df$Diff_Level <- c(NA, diff(ts_df$`Banana, US`))  # First difference, NA for the first value

# Plotting Price Developments in Levels, Logs, and First Differences

# Levels Plot
ggplot(ts_df, aes(x = Date, y = `Banana, US`)) +
  geom_line() +
  labs(title = "Price Developments in Levels", y = "Level (USD)", x = "Month") +
  theme_minimal()

# Log Plot
ggplot(ts_df, aes(x = Date, y = Log_Level)) +
  geom_line() +
  labs(title = "Price Developments in Log-Levels", y = "Log(Level)", x = "Month") +
  theme_minimal()

# First Differences Plot
ggplot(ts_df, aes(x = Date, y = Diff_Level)) +
  geom_line() +
  labs(title = "First Differences of Price Developments", y = "First Difference (USD)", x = "Month") +
  theme_minimal()

# Histograms and Kernel Densities

# Histogram for Levels
ggplot(ts_df, aes(x = `Banana, US`)) +
  geom_histogram(aes(y = ..density..), bins = 20, fill = "skyblue", color = "black") +
  geom_density(alpha = 0.2, fill = "red") +
  labs(title = "Histogram and Kernel Density of Levels", x = "Level (USD)", y = "Density") +
  theme_minimal()

# Histogram for Log-Levels
ggplot(ts_df, aes(x = Log_Level)) +
  geom_histogram(aes(y = ..density..), bins = 20, fill = "lightgreen", color = "black") +
  geom_density(alpha = 0.2, fill = "blue") +
  labs(title = "Histogram and Kernel Density of Log-Levels", x = "Log(Level)", y = "Density") +
  theme_minimal()

# Scatterplot of Levels vs Lagged Levels
ts_df$Lagged_Level <- lag(ts_df$`Banana, US`, 1)  # Creating lagged series
ggplot(ts_df, aes(x = Lagged_Level, y = `Banana, US`)) +
  geom_point() +
  labs(title = "Scatterplot of Levels vs Lagged Levels", x = "Lagged Level (USD)", y = "Level (USD)") +
  theme_minimal()
    
    ```
